<script>
    document.addEventListener('DOMContentLoaded', () => {
        const contributionForm = document.getElementById('contribution-form');
        const contributionsBody = document.getElementById('contributions-body');
        const expensesBody = document.getElementById('expenses-body');
        const totalContributionsDisplay = document.getElementById('total-contributions');
        const totalExpensesDisplay = document.getElementById('total-expenses');
        const balanceDisplay = document.getElementById('balance');

        const multiExpenseBody = document.getElementById('multi-expense-body');
        const addRowBtn = document.getElementById('add-expense-row');
        const submitAllBtn = document.getElementById('submit-all-expenses');

        let contributions = loadContributions();
        let expenses = loadExpenses();

        setDefaultDates();
        renderContributions();
        renderExpenses();
        updateBalance();

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('contribution-date').value = today;
        }

        contributionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const contributor = document.getElementById('contributor').value;
            const date = document.getElementById('contribution-date').value;
            const amount = parseFloat(document.getElementById('contribution-amount').value);

            const newContribution = { date, contributor, amount };
            contributions.push(newContribution);
            saveContributions();
            renderContributions();
            updateBalance();
            contributionForm.reset();
            setDefaultDates();
        });

        addRowBtn.addEventListener('click', () => {
            const today = new Date().toISOString().split('T')[0];
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="date" value="${today}" required></td>
                <td><input type="text" required></td>
                <td><input type="number" min="0.01" step="0.01" required></td>
                <td><input type="number" min="0.01" step="0.01" required></td>
                <td><button class="delete-btn remove-row">Delete</button></td>
            `;
            multiExpenseBody.appendChild(row);
        });

        multiExpenseBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-row')) {
                e.target.closest('tr').remove();
            }
        });

        submitAllBtn.addEventListener('click', () => {
            const rows = multiExpenseBody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('input');
                const date = cells[0].value;
                const item = cells[1].value;
                const quantity = parseFloat(cells[2].value);
                const unitPrice = parseFloat(cells[3].value);
                if (!date || !item || isNaN(quantity) || isNaN(unitPrice)) return;
                const totalCost = quantity * unitPrice;
                const newExpense = { date, item, quantity, unitPrice, totalCost };
                expenses.push(newExpense);
            });

            saveExpenses();
            renderExpenses();
            updateBalance();
            multiExpenseBody.innerHTML = '';
        });

        function renderContributions() {
            contributionsBody.innerHTML = '';
            let total = 0;
            contributions.forEach((c, i) => {
                const row = contributionsBody.insertRow();
                row.innerHTML = `
                    <td>${c.date}</td>
                    <td>${c.contributor}</td>
                    <td>₹${c.amount.toFixed(2)}</td>
                    <td><button class="delete-btn" onclick="deleteContribution(${i})">Delete</button></td>
                `;
                total += c.amount;
            });
            totalContributionsDisplay.textContent = `₹${total.toFixed(2)}`;
        }

        function renderExpenses() {
            expensesBody.innerHTML = '';
            let total = 0;
            expenses.forEach((e, i) => {
                const row = expensesBody.insertRow();
                row.innerHTML = `
                    <td>${e.date}</td>
                    <td>${e.item}</td>
                    <td>${e.quantity}</td>
                    <td>₹${e.unitPrice.toFixed(2)}</td>
                    <td>₹${e.totalCost.toFixed(2)}</td>
                    <td><button class="delete-btn" onclick="deleteExpense(${i})">Delete</button></td>
                `;
                total += e.totalCost;
            });
            totalExpensesDisplay.textContent = `₹${total.toFixed(2)}`;
        }

        function updateBalance() {
            const totalContributions = contributions.reduce((sum, c) => sum + c.amount, 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + e.totalCost, 0);
            const balance = totalContributions - totalExpenses;
            balanceDisplay.textContent = `₹${balance.toFixed(2)}`;
        }

        function saveContributions() {
            localStorage.setItem('saladClubContributions', JSON.stringify(contributions));
        }

        function loadContributions() {
            const stored = localStorage.getItem('saladClubContributions');
            return stored ? JSON.parse(stored) : [];
        }

        function saveExpenses() {
            localStorage.setItem('saladClubExpenses', JSON.stringify(expenses));
        }

        function loadExpenses() {
            const stored = localStorage.getItem('saladClubExpenses');
            return stored ? JSON.parse(stored) : [];
        }

        window.deleteContribution = function(index) {
            contributions.splice(index, 1);
            saveContributions();
            renderContributions();
            updateBalance();
        }

        window.deleteExpense = function(index) {
            expenses.splice(index, 1);
            saveExpenses();
            renderExpenses();
            updateBalance();
        }
    });
</script>